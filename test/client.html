<!--
@http://www.cnblogs.com/zhuweisky/p/3930780.html
-->
<!DOCTYPE html>
</html>
    <head>
        <meta charset="utf-8">
    </head>
    <body>
        <h3>WS Test</h3>
        <div id="info"></div>
        <div id="login">
            <div>
                <input id="serverIP" type="text" placeholder="服务器IP" value="192.168.225.1" autofocus="autofocus" />
                <input id="serverPort" type="text" placeholder="服务器端口" value="9000" />
                <input id="btnConnect" type="button" value="连接" onclick="connect()" />
                <input id="btnDisconnect" type="button" value="断开" onclick="disconnect()" />
            </div>
            <div>
                <input id="sendText" type="text" placeholder="发送文本" value="I'm WebSocket Client!" />
                <input id="btnSend" type="button" value="发送" onclick="send()" />
            </div>
            <div>
                <div>
                    来自服务端的消息
                </div>
                <textarea id="txtContent" cols="50" rows="10" readonly="readonly"></textarea>
            </div>
            <div>
                <table>
                    <tr>
                        <td>input_dev</td>
                        <td>
                            <select id="input_dev">
                                    <option value="0">"None"</option>
                                    <option value="1">"IN1"</option>
                            </select>
                        </td>
                        <td>output_dev</td>
                        <td>
                            <select id="output_dev">
                                    <option value="16">"OUT1"</option>
                                    <option value="32">"OUT2"</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>mic_preamp</td>
                        <td>
                            <select id="mic_preamp">
                                <option value="0">"Disable"</option>
                                <option value="1">"0dB"</option>
                                <option value="2">"20dB"</option>
                                <option value="3">"30dB"</option>
                            </select>
                        </td>
                        <td>mic_gain</td>
                        <td>
                            <select id="mic_gain">
                                    <option value="0">"0"</option>
                                    <option value="1">"1"</option>
                                    <option value="2">"2"</option>
                                    <option value="3">"3"</option>
                                    <option value="4">"4"</option>
                                    <option value="5">"5"</option>
                                    <option value="6">"6"</option>
                                    <option value="7">"7"</option>
                                    <option value="8">"8"</option>
                                    <option value="9">"9"</option>
                                    <option value="10">"10"</option>
                                    <option value="11">"11"</option>
                                    <option value="12">"12"</option>
                                    <option value="13">"13"</option>
                                    <option value="14">"14"</option>
                                    <option value="15">"15"</option>
                                    <option value="16">"16"</option>
                                    <option value="17">"17"</option>
                                    <option value="18">"18"</option>
                                    <option value="19">"19"</option>
                                    <option value="20">"20"</option>
                            </select>
                        </td>
                        <td>adc_level</td>
                        <td>
                            <select id="adc_level">
                                <option value="-12">"-12"</option>
                                <option value="-11">"-11"</option>
                                <option value="-10">"-10"</option>
                                <option value="-9">"-9"</option>
                                <option value="-8">"-8"</option>
                                <option value="-7">"-7"</option>
                                <option value="-6">"-6"</option>
                                <option value="-5">"-5"</option>
                                <option value="-4">"-4"</option>
                                <option value="-3">"-3"</option>
                                <option value="-2">"-2"</option>
                                <option value="-1">"-1"</option>
                                <option value="0">"0"</option>
                                <option value="1">"1"</option>
                                <option value="2">"2"</option>
                                <option value="3">"3"</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>dac_gain</td>
                        <td>
                            <select id="dac_gain">
                                <option value="0">"0dB"</option>
                                <option value="1">"6dB"</option>
                                <option value="2">"12dB"</option>
                                <option value="3">"18dB"</option>
                            </select>
                        </td>
                        <td>dac_atten</td>
                        <td>
                            <select id="dac_atten">
                                <option value="0">"0"</option>
                                <option value="1">"1"</option>
                                <option value="2">"2"</option>
                                <option value="3">"3"</option>
                                <option value="4">"4"</option>
                                <option value="5">"5"</option>
                                <option value="6">"6"</option>
                                <option value="7">"7"</option>
                                <option value="8">"8"</option>
                                <option value="9">"9"</option>
                                <option value="10">"10"</option>
                                <option value="11">"11"</option>
                                <option value="12">"12"</option>
                                <option value="13">"13"</option>
                                <option value="14">"14"</option>
                                <option value="15">"15"</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>filter_mode</td>
                        <td>
                            <select id="filter_mode">
                                <option value="0">"Voice"</option>
                                <option value="1">"Audio"</option>
                            </select>
                        </td>
                        <td>in_filter</td>
                        <td>
                            <select id="in_filter">
                                <option value="0">"Disabled"</option>
                                <option value="1">"Elliptical_For_16KHz_GSM"</option>
                                <option value="2">"500Hz_Butterworth_For_16KHz"</option>
                                <option value="3">"Elliptical_For_8KHz_GSM"</option>
                                <option value="4">"500Hz_Butterworth_For_8KHz"</option>
                                <option value="5">"Fs_240_Butterworth_For_8_To_24KHz"</option>
                            </select>
                        </td>
                        <td>out_filter</td>
                        <td>
                            <select id="out_filter">
                                <option value="0">"Disabled"</option>
                                <option value="1">"Elliptical_For_16KHz_GSM"</option>
                                <option value="2">"500Hz_Butterworth_For_16KHz"</option>
                                <option value="3">"Elliptical_For_8KHz_GSM"</option>
                                <option value="4">"500Hz_Butterworth_For_8KHz"</option>
                                <option value="5">"Fs_240_Butterworth_For_8_To_24KHz"</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>output_mode</td>
                        <td>
                            <select id="output_mode">
                                <option value="0">"Differential"</option>
                                <option value="1">"Capacitor_Less"</option>
                                <option value="2">"Single_Ended_Clickless"</option>
                                <option value="3">"Single_Ended_Fast"</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input id="btnCfgAudio" type="button" value="ConfigAudio" onclick="cfgAudio()" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </body>

    <script>
        var socket;

        function notifyInfo(info) {
            $("info").innerHTML = info;
        }

        function connect() {
            var host = "ws://" + $("serverIP").value + ":" + $("serverPort").value + "/"
            socket = new WebSocket(host);
            try {

                socket.onopen = function (msg) {
                    $("btnConnect").disabled = true;
                    notifyInfo("连接成功！");
                };

                socket.onmessage = function (msg) {
                    if (typeof msg.data == "string") {
                        displayContent(msg.data);
                    }
                    else {
                        notifyInfo("非文本消息");
                    }
                };

                socket.onclose = function (msg) {
                    notifyInfo("ws closed!");
                    $("btnConnect").disabled = false;
                    $("btnDisconnect").disabled = true;
                };
            }
            catch (ex) {
                log(ex);
            }
        }

        function disconnect() {
            try {
                socket.close();
                socket = null;
            }
            catch (ex) {
                notifyInfo("ws disconnect failed");
            }
        }

        function send() {
            if (socket) {
                var msg = $("sendText").value + '\0';
                socket.send(msg);
            } else {
                notifyInfo("ws not connected!");
            }
        }

        function sendMsg(func, parm) {
            if (socket) {
                var msg = {"func": func, "parm": parm};
                var jsonStr = JSON.stringify(msg);
                socket.send(jsonStr);
            } else {
                notifyInfo("ws not connected!");
            }
        }

        function dispatchMsg(jsonStr) {
            var dat = JSON.parse(jsonStr);
            if (dat["func"] == "") {

            }
        }

        function cfgAudio() {
            var audioParm = {
                "input_dev":  $("input_dev").value,
                "output_dev": $("output_dev").value,
                "mic_preamp": $("mic_preamp").value,
                "mic_gain":   $("mic_gain").value,
                "adc_level":  $("adc_level").value,
                "dac_gain":   $("dac_gain").value,
                "dac_atten":  $("dac_atten").value,
                "in_filter":  $("in_filter").value,
                "out_filter": $("out_filter").value,
                "output_mode": $("output_mode").value,
            };

            sendMsg("ConfigAudio", audioParm);
        }

        window.onbeforeunload = function () {
            disconnect();
        };

        function $(id) { return document.getElementById(id); }

        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }

        function displayContent(msg) {
            $("txtContent").value += "\r\n" + new Date().Format("yyyy/MM/dd hh:mm:ss")+ ":  " + msg;
        }

        function onkey(event) {
            if (event.keyCode == 13) {
                send();
            }
        }
    </script>
</html>